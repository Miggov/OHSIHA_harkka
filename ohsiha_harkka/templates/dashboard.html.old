<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
   <style>#mapid { height: 400px; }</style>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>
   <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
   <script src="https://code.highcharts.com/highcharts.js"></script>
   <script src="https://code.highcharts.com/modules/exporting.js"></script>
   <script src="https://code.highcharts.com/modules/export-data.js"></script>
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

    <div class='container-fluid'>
      <div class='row mt-3'>
        <div class='col-9'>
          <div id="mapid">
            <script>
              function load_data() {
                fetch('http://127.0.0.1:8000/app/TrafficLights')
                  .then(res => res.json())
                  .then(data => TrafficLights = data)
                  .then(function(TrafficLights){
                    //let bounds = mymap.getBounds();
                    for (let i=0;i<TrafficLights.length;i++){
                      let status = TrafficLights[i]['status'];
                      let lat = parseFloat(TrafficLights[i]['coordinate_x']);
                      let lon = parseFloat(TrafficLights[i]['coordinate_y']);
                      let circle = L.circle([lat, lon], {
                        color: status,
                        fillOpacity: 1,
                        radius: 5}).addTo(mymap);
                      //let latlon = L.latlng(lat, lon);
                    // console.log('iltua');
                    //  if (bounds.contains(latlon)){ 
                    // }
                    }
                  })
              }

              var mymap = L.map('mapid').setView([61.448357, 23.854091], 17); //Setting default centerplace for the map

              // Loading gmaps layer
              googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ 
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3']
            }).addTo(mymap);

          
              mymap.on('moveend', load_data);
              load_data();
            </script>
          </div>
        </div>
        <div class="col-3" style="min-width": 300px>
            <div id="forecast">
                <iframe src="http://forecabox.foreca.com/get/43928" width="300" height="250" marginwidth="0" marginheight="0" frameborder="0" scrolling="no" allowtransparency="true"></iframe>
              </div>
              <div class='row'>
                  <div class='col-4 col-offset-4'>
                    <div id="managebuttons">
                      <form action = "app/update" method = "get" id = "update"> 
                        <input type = "submit" class = "button" id = "button1" value = "Lataa tiedot rajapinnasta" name = "updateAPI"></form>
                        <p></p>
                    </div>
                  </div>
                </div>
        </div>
        </div>
      </div>

      <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto">
        <script>
            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });
            
            Highcharts.chart('container', {
                chart: {
                    type: 'spline',
                    animation: Highcharts.svg, // don't animate in old IE
                    marginRight: 10,
                    events: {
                        load: function () {
            
                            // set up the updating of the chart each second
                            var series = this.series[0];
                            setInterval(function () {
                                var x = (new Date()).getTime(), // current time
                                    y = Math.random();
                                series.addPoint([x, y], true, true);
                            }, 1000);
                        }
                    }
                },
                title: {
                    text: 'Live random data'
                },
                xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
                },
                yAxis: {
                    title: {
                        text: 'Value'
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                tooltip: {
                    formatter: function () {
                        return '<b>' + this.series.name + '</b><br/>' +
                            Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                            Highcharts.numberFormat(this.y, 2);
                    }
                },
                legend: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                series: [{
                    name: 'Random data',
                    data: (function() {
                      var arr = [];
                      return fetch('http://127.0.0.1:8000/app/TrafficAmount')
                        .then(res => res.json())
                      //  .then(data => TrafficAmount = data)
                        .then(function(TrafficAmount){
                        //  console.log(TrafficAmount.length)
                          for (let i=0;i<TrafficAmount.length;i++){ // && i>50
                            let time = TrafficAmount[i]['timestamp'];
                            let tramount = parseFloat(TrafficAmount[i]['traffic_amount']);
                            var subarr = ([Date(time), tramount]);
                            arr.push(subarr);
                          }
                          console.log(arr);                            
                          return arr;
                        }) 
                        }())
                }]
            });
        </script>
      </div>


    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
  </body>
</html>